pipeline {
    agent any

    environment {
        DEPLOY_SERVER = 'ubuntu@49.50.134.161'
        APP_NAME = 'my-backend'
        JAR_PATH = 'demo/build/libs/my-backend-0.0.1-SNAPSHOT.jar'
    }

   stage('Deploy') {
    steps {
        sshagent(['ubuntu']) {
            sh '''
            echo "ğŸ“¦ ë°°í¬ ì„œë²„ì— jar ë³µì‚¬ ì¤‘..."
            JAR_FILE=$(find demo/build/libs -type f -name "*.jar" | head -n 1)
            echo "âœ… ì°¾ì€ JAR íŒŒì¼: $JAR_FILE"

            if [ -z "$JAR_FILE" ]; then
                echo "âŒ JAR íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¹Œë“œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”."
                exit 1
            fi

            scp $JAR_FILE $DEPLOY_SERVER:/home/ubuntu/$APP_NAME.jar

            echo "ğŸ›‘ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘..."
            ssh $DEPLOY_SERVER "pkill -f $APP_NAME || true"

            echo "ğŸš€ ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘..."
            ssh $DEPLOY_SERVER "nohup java -jar /home/ubuntu/$APP_NAME.jar > app.log 2>&1 &"
            '''
        }
    }
}


    post {
        success {
            echo "âœ… ë°°í¬ ì„±ê³µ!"
        }
        failure {
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
        }
    }
}
