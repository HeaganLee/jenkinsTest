pipeline {
    agent any

    environment {
        DEPLOY_SERVER = 'root@49.50.134.161'
        APP_NAME = 'my-backend'
    }

    stages {
        stage('Build') {
            steps {
                sh '''
                echo "🔨 Gradle 빌드 시작..."
                cd demo
                chmod +x gradlew
                ./gradlew clean build -x test
                echo "✅ 빌드 완료"
                '''
            }
        }

        stage('Deploy') {
            steps {
                sshagent(['root']) {
                    sh '''
                    set -e
                    echo "📦 배포 서버에 jar 복사 중..."
                    JAR_FILE=$(find demo/build/libs -type f -name "*.jar" | head -n 1)
                    echo "✅ 찾은 JAR 파일: $JAR_FILE"

                    if [ -z "$JAR_FILE" ]; then
                        echo "❌ JAR 파일을 찾지 못했습니다. 빌드 결과를 확인하세요."
                        exit 1
                    fi

                    echo "➡️ 서버 연결 테스트 중..."
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER "echo '✅ SSH 연결 성공: $(hostname)'"

                    echo "📤 JAR 복사 중..."
                    scp -o StrictHostKeyChecking=no $JAR_FILE $DEPLOY_SERVER:/root/${APP_NAME}.jar

                    echo "🛑 기존 프로세스 종료 시도 중..."
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER "pkill -f ${APP_NAME} || echo '⚠️ 기존 프로세스 없음'"

                    echo "🚀 새 프로세스 실행 중..."
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER "nohup java -jar /root/${APP_NAME}.jar > /root/app.log 2>&1 &"

                    echo "📋 현재 실행 중 프로세스 확인:"
                    ssh -o StrictHostKeyChecking=no $DEPLOY_SERVER "ps aux | grep ${APP_NAME} || true"

                    echo "🎉 배포 완료!"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ 전체 파이프라인 성공!"
        }
        failure {
            echo "❌ 파이프라인 실패!"
        }
    }
}
